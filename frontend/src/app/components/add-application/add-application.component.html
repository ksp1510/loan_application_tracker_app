<!-- add-application.component.html -->
<div class="form-container">
  <mat-card class="form-card">
    <mat-card-title>Loan Application</mat-card-title>
    @if (applicationForm) {
    <mat-card-content [formGroup]="applicationForm" [@formFadeIn]>

      <!-- Application Summary Fields -->
      <div class="summary-row form-row">
        <mat-form-field class="half-width" appearance="fill" [class.invalid-field]="isFieldInvalid('amount')">
          <mat-label>Requested Loan Amount</mat-label>
          <input matInput formControlName="amount" type="number">
          @if (isFieldInvalid('amount')) {
            <mat-error>Loan amount is required</mat-error>
          }
        </mat-form-field>

        <mat-form-field class="half-width" appearance="fill" [class.invalid-field]="isFieldInvalid('security')">
          <mat-label>Security</mat-label>
          <mat-select formControlName="security">
            <mat-option value="Vehicle">Vehicle</mat-option>
            <mat-option value="Property">Property</mat-option>
            <mat-option value="Co-Signer">Co-Signer</mat-option>
            <mat-option value="N/A">N/A</mat-option>
          </mat-select>
          @if (isFieldInvalid('security')) {
            <mat-error>Security is required</mat-error>
          }
        </mat-form-field>

        <mat-form-field class="half-width" appearance="fill" [class.invalid-field]="isFieldInvalid('status')">
          <mat-label>Status</mat-label>
          <mat-select formControlName="status">
            <mat-option value="APPLIED">Applied</mat-option>
            <mat-option value="FUNDED">Funded</mat-option>
            <mat-option value="DECLINED">Declined</mat-option>
          </mat-select>
          @if (isFieldInvalid('status')) {
            <mat-error>Status is required</mat-error>
          }
        </mat-form-field>

        <mat-form-field class="full-width" appearance="fill">
          <mat-label>Notes</mat-label>
          <textarea matInput formControlName="notes"></textarea>
        </mat-form-field>
      </div>

      <!-- Main Applicant Section -->
      <div class="section-card" [@formFadeIn]>
        <h3 class="section-title">Main Applicant</h3>
        @if (mainApplicantGroup) {
        <app-applicant-form [formGroup]="mainApplicantGroup">
        </app-applicant-form>
        }
      </div>

      <!-- Toggle Co-Applicant -->
      <mat-slide-toggle formControlName="hasCoApplicant">Add Co-Applicant</mat-slide-toggle>
      @if (applicationForm.get('hasCoApplicant')?.value && coApplicantGroup) {
        <div class="section-card" [@formFadeIn]>
        <h3 class="section-title">Co-Applicant</h3>
        <app-applicant-form [formGroup]="coApplicantGroup">
        </app-applicant-form>
      </div>
      }
      



      <!-- Income Section -->
      <div class="section-card">
        <h3 class="section-title">Monthly Income</h3>
        <div class="form-row">
          <mat-form-field appearance="fill">
            <mat-label>Full Time Income</mat-label>
            <input matInput formControlName="ft_income" type="number">
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Part Time Income</mat-label>
            <input matInput formControlName="pt_income" type="number">
          </mat-form-field>
        </div>
        <div class="form-row">
          <mat-form-field appearance="fill">
            <mat-label>Child Tax</mat-label>
            <input matInput formControlName="child_tax" type="number">
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Govt Support</mat-label>
            <input matInput formControlName="govt_support" type="number">
          </mat-form-field>
        </div>
        <div class="form-row">
          <mat-form-field appearance="fill">
            <mat-label>Pension</mat-label>
            <input matInput formControlName="pension" type="number">
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Other Income</mat-label>
            <input matInput formControlName="other_income" type="number">
          </mat-form-field>
        </div>
        
        <div class="form-row">
          <mat-form-field appearance="fill">
            <mat-label>Total Income</mat-label>
            <input matInput [value]="getTotalIncome('main')" disabled>
          </mat-form-field>
        </div>
      </div>

      <!-- Expenses Section -->
      <div class="section-card">
        <h3 class="section-title">Monthly Expenses</h3>
        <div class="form-row">
          <mat-form-field appearance="fill">
            <mat-label>Utilities</mat-label>
            <input matInput formControlName="utilities" type="number">
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Property Taxes</mat-label>
            <input matInput formControlName="property_taxes" type="number">
          </mat-form-field>
        </div>
        <div class="form-row">
          <mat-form-field appearance="fill">
            <mat-label>Child Support</mat-label>
            <input matInput formControlName="child_support" type="number">
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Groceries</mat-label>
            <input matInput formControlName="groceries" type="number">
          </mat-form-field>
        </div>
        <div class="form-row">
          <mat-form-field appearance="fill">
            <mat-label>Car Insurance</mat-label>
            <input matInput formControlName="car_insurence" type="number">
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Car Payment</mat-label>
            <input matInput formControlName="car_payment" type="number">
          </mat-form-field>
        </div>
        <div class="form-row">
          <mat-form-field appearance="fill">
            <mat-label>Phone Bill</mat-label>
            <input matInput formControlName="phone_bill" type="number">
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Internet</mat-label>
            <input matInput formControlName="internet" type="number">
          </mat-form-field>
        </div>
        <div class="form-row">
          <mat-form-field appearance="fill">
            <mat-label>Total</mat-label>
            <input matInput [value]="getTotalExpenses('main')" disabled>
          </mat-form-field>
        </div>
      </div>

      <!-- Loan Repeater Section -->
      <div class="section-card">
        <h3 class="section-title">Existing Loans</h3>
        <div formArrayName="loan">
          @for (loan of mainApplicantLoans.controls; track loan; let i = $index) {
            <div [formGroupName]="i">
              <mat-form-field appearance="fill">
                <mat-label>Institution</mat-label>
                <input matInput formControlName="financial_institution">
              </mat-form-field>
              <mat-form-field appearance="fill">
                <mat-label>Monthly Payment</mat-label>
                <input matInput formControlName="monthly_pymnt" type="number">
              </mat-form-field>
              <button mat-icon-button color="warn" (click)="removeLoan('main', i)">
                <mat-icon>-</mat-icon>
              </button>
            </div>
          }
          <button mat-button color="accent" (click)="addLoan('main')">Add Another Loan</button>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="form-actions">
        <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="applicationForm.invalid">
          Submit Application
        </button>
      </div>

    </mat-card-content>
    }
  </mat-card>
</div>
